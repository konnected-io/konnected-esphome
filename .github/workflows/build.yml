name: Build

on: 
  push:
    branches:
      - '**'
    tags-ignore:
      - '**'
  release:
    types: [created]

jobs:
  build-upload:
    runs-on: ubuntu-latest
    name: Build
    steps:
      - uses: actions/checkout@v3
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install ESPHome
        run: | 
          pip3 install wheel
          pip3 install esphome
          echo "esphome_version=$(esphome version) >> $GITHUB_OUTPUT"
          mkdir assets
      
      - id: alarm-panel-esp8266-version
        uses: jbutcher5/read-yaml@main
        with:
          file: './packages/alarm-panel-esp8266-base.yaml'
          key-path: '["substitutions", "project_version"]'

      - name: Build Alarm Panel ESP8266
        id: build-alarm-panel-esp8266
        run: | 
          esphome compile alarm-panel-esp8266.yaml
          build_path=.esphome/build/alarm-panel/.pioenvs/alarm-panel
          fname=konnected-esphome-alarm-panel-esp8266-${{ steps.alarm-panel-esp8266-version.outputs.data }}.bin          
          cp $build_path/firmware-factory.bin assets/$fname
          echo "fname=$fname" >> $GITHUB_OUTPUT
  
      - name: Upload Builds
        uses: mamal72/minio-perfect-deploy-action@main
        with:
          endpoint: ${{ secrets.MINIO_ENDPOINT }}
          access_key: ${{ secrets.MINIO_ACCESS_KEY }}
          secret_key: ${{ secrets.MINIO_SECRET_KEY }}
          bucket: 'konnected'
          source_dir: 'assets'
          target_dir: '/'

      - name: Get release
        if: github.event.release
        id: get_release
        uses: bruceadams/get-release@v1.3.2
        env:
          GITHUB_TOKEN: ${{ github.token }}

      - name: Upload asset to release
        if: github.event.release
        uses: bgpat/release-asset-action@03b0c30db1c4031ce3474740b0e4275cd7e126a3
        with:
          pattern: "assets/*"
          release-url: ${{ steps.get_release.outputs.upload_url }}
          allow-overwrite: true
          github-token: ${{ secrets.GITHUB_TOKEN }}
